{{!< default}}
{{!-- 
/**
 * @Stake v3
 * Developed by Engagement Lab, 2016-2017
 * ==============
 * 
 * Script includes partial for PLAYERS socket.io events
 * ==========
 */
--}}

var clockInterval;
var countdownAnim;
var playerWasReconnected;
var startAnim = new TimelineLite({paused: true}).fromTo($('#btn-start-game'), 1, {scale:0, autoAlpha:0}, {scale:1, autoAlpha:1, visibility:'visible', ease:Elastic.easeOut});

// If true, screen doesn't advance right away via 'game:next',
// it is saved in nextScreenData and advanced to later
var waitForNextScreen = false;
var nextScreenData;

var resetSession = function() {

    // Remove saved game code, uid, and set to not reconnected
    sessionStorage.removeItem('gameCode');
    sessionStorage.removeItem('uUID');
    sessionStorage.setItem('reconnected', false);

}

var setupTriggers = function() {

    // Add trigger to go to next step on next-step buttons
    $('.next-step').click(function(evt) {
        nextPhaseScreen();
    });

    // Reset screen index
    currentScreenIndex = 0;

    $(isDecider ? '.player' : '.decider').remove();

    if ($('#gameContent').hasClass('login'))
        $('#gameContent').removeClass('login');
    else if ($('#gameContent').hasClass('player-grid'))
        $('#gameContent').removeClass('player-grid');

    $('#gameContent').addClass('in-game');
    $('#stages-bar').show();

    // This makes duplicate of all speech bubbles and 
    // makes them all child of respective bubble,
    // in order to achieve proper "bottom border" effect
    _.each($('.screen blockquote.speech'), function(el, i) {
        $(el).clone().addClass('under').remove('button').appendTo(el);
    });

    // Show initial
    $('.screen.initial').show();
    sessionStorage.setItem('markup', $('#gameContent').html());

    currentPhaseIndex = sessionStorage.getItem('phase');
    currentScreenIndex = sessionStorage.getItem('screen');

    phaseBarProgress();

}

socketEvents = function(eventId, eventData) {

    switch (eventId) {

        case 'connect':
            
            if(sessionStorage.getItem('gameCode')) {
                // Check if player is active in game
                socket.emit('login:active', {
                  gameId: sessionStorage.getItem('gameCode'), 
                  username: sessionStorage.getItem('username'),
                  uid: sessionStorage.getItem('uUID'),
                  decider: isDecider
                });
            }

            if(isDecider) {
                // Session started, let's sign-up the decider for this room
                socket.emit('room', emitData({type: 'decider', username: $('#player-name').val(), uid: playerUID}));
            }
            else {
                // Connected, let's sign-up for to receive messages for this room
                socket.emit('room', emitData('player'));
            }

            $('#gameContent').addClass('player-grid');

            $('.login.form').fadeOut(function() { $('.login.waiting').fadeIn(function(){
                $('.lobby#join').addClass('player-grid');
            }); });
            
            break;

        case 'disconnect':

            if(gameEnded)
                return;

            // Remove saved sesh
            resetSession();

            if ($('.modal'))
                $('.modal').fadeOut();

            $('#error-disconnected').fadeIn(function() {
                $('#error-disconnected #text').css('top', '0');
            });

            break;

        case 'player:loggedin':

            {{!-- $('#gameContent').html(eventData.html); --}}

            sessionStorage.setItem("gameType", eventData.gameType);
            
            playerWasReconnected = false;

            $('#debug-info').text('Player id: ' + eventData.id);

            playerId = eventData.id;

            $('#bottom-bar').show();

            break;

        case 'player:reconnected': 

            // Set local player state as reconnected
            playerWasReconnected = true;

            var markup = sessionStorage.getItem('markup');
            markup = $(markup).not('blockquote.speech.under');

            $('#bottom-bar').show();
            $('#gameContent').html(markup).promise().done(function() {
                
                setupTriggers();

            });

            break;

        case 'player:lost':

            // A current player lost from session
            var timeLeft = eventData.timeout;
            var modal = $('#error-player-disconnected');
            
            modal.find('h2 #player').text(eventData.name);
            modal.find('h2 #time').text(timeLeft + 's');
            modal.show();

            var timeoutClock = setInterval(function() {

                timeLeft--;
                modal.find('h2 #time').text(timeLeft + 's');

                if(timeLeft === 0)
                    clearInterval(timeoutClock);

            }, 1000);

            break;

        case 'players:update':

            if(eventData.state === 'rejoined') {
                $('#error-player-disconnected').hide();
                return;
            }

            var staticPlayers = $('.player-static');
            var currentPlayers = _.map(eventData.players, function(player){
                return {name: player.username, icon: player.index};
            });

            var playersNeeded = {{#ifeq debug true}}2{{else}}3{{/ifeq}}

            // Allow to start?
            if(currentPlayers.length === playersNeeded)
                startAnim.play();
            else if(currentPlayers.length < playersNeeded)
                startAnim.reverse();

            $('#players').empty();

            _.each(currentPlayers, function(player, index) {

                var nameFormatted = (player.name.length <= 15) ? player.name : player.name.substring(0, 15) + "...";
                var index = player.icon;

                $('#players').append('<div id="player-' + index + '" class="col-sm-12 player-logo"><p>' + nameFormatted + '</p></div>');

            });

            break;

        case 'player:agenda_item':

            // Don't let next screen take over yet
            waitForNextScreen = true;

            var container = eventData.chosen ? $('#chosen') : $('#not-chosen');
            
            // Edit coin count
            container.text(container.text().replace('{coins}', eventData.coins));

            var chosenAnim = new TimelineLite({onComplete: function() {

                setTimeout(function() { updateGameContent(nextScreenData, function() {

                    waitForNextScreen = false;
                    nextScreenData = undefined;

                }) }, 1400);

            }});

            chosenAnim.from(container, .6, {scale:0, autoAlpha: 0, ease:Elastic.easeOut});

            break;

        case 'player:assignrole':

            $('#role-card').html(eventData);
            $('#btn-close-role-card').on('click', function(evt) {
                console.log("closing");
                $('#role-card').removeClass('open').addClass('closed');
            });
            $('#btn-role-card').on('click', function(evt) {
                $('#role-card').removeClass('closed').addClass('open');
            });
            $('#role-card').on('swipe', function() {
                console.log("closing");
                $('#role-card').removeClass('open').addClass('closed');
            });

            break;

        case 'game:start':

        case 'game:next_item':

            $('#agenda-items .role:visible').remove();
            $('#agenda-items .role').first().show();

            break;

        case 'game:next_screen':

            // Only occurs for non-decider, since decider sends this
            if(!isDecider)
                nextPhaseScreen();

            break;

        case 'game:next_phase':

            $('#stages-bar').show();
            sessionStorage.setItem('gameCode', gameCode);

            // Don't show yet?
            if(waitForNextScreen) {
                nextScreenData = eventData;
                return;
            }

            updateGameContent(eventData, function() {

                rulesAnim();
                nextPhase();
                setupTriggers();

            });
            
            break;

        case 'game:refresh_screen':

            updateGameContent(eventData, function() {

                setupTriggers();

                // Move immediately to restart point in current phase, by removing screens before it and showing it
                $('.screen.restart').prevAll().remove();
                $('.screen.restart').show();

            });

            break;

        case 'game:ending':

            $('#error-box').text(eventData);
            $('#error-box').show();

            break;

        case 'game:ended':

            // Reset game session data and send back to logn
            resetSession();
            window.location = window.location;

            $('#gameContent').html(eventData);

            break;

        case 'game:resumed':

            $('#error-box').hide();

            break;

        case 'game:notfound':

            if(isDecider) return;

            $('#error-box').text('game not found!');
            $('#error-box').show();

            break;
            
        case 'game:countdown':

            $('#btn-time').fadeOut();

            if(clockInterval)
                clearInterval(clockInterval);

            if(countdownAnim)
                countdownAnim.destroy();

            var secondsLeft = eventData.duration;                    
            clockInterval = setInterval(function() {

                function clockTick() {
                    $('#countdown').text(secondsLeft + ' seconds');
                    secondsLeft--;
                }

                clockTick();

                if(secondsLeft === 0)
                    clearInterval(clockInterval);
            }, 1000);
            
            countdownAnim = new ProgressBar.Circle(
              '.screen .timer', 
              {
                  color: '#fff',
                  duration: secondsLeft*1000,
                  easing: 'easeInOut',
                  strokeWidth: 6,
                  trailColor: 'rbga(235, 235, 235, 0.5)',
                  trailWidth: 0.8,
                  fill: '#20b5e6',
                  // Set default step function for all animate calls
                  step: function(state, circle) {
                      circle.setText(secondsLeft);
                  }
              }
            );
            countdownAnim.animate(1);

            break;

        case 'game:countdown_ending':

            $('.form .error').fadeIn().html(eventData);

            break;


        case 'game:countdown_ending':

            $('.form .error').fadeIn().html(eventData);

            break;

        case 'game:countdown_end':

            $('#added-time').hide();

            runMods();
            
            $('#more-time').fadeIn();
            $('#btn-more-time,#btn-cancel').click(function() { $('#more-time').fadeOut()} );

            if(isDecider)
                $('#btn-next').show();

            break;

        case 'game:countdown_player':
            
            $('#added-time').text(eventData + " is speaking, since they added more time.").fadeIn();

            break;

        case 'game:player_done':
            
            $('#btn-next-player').fadeIn();

            break;

        case 'game:phase_over':
            
            $('#btn-next-stage').fadeIn();

            break;

        case 'game:decider':

            isDecider = eventData;

            break;

        case 'game:end':

            $('#gameContent').html(eventData);

            var nextRoundAnim = new TimelineLite({ paused:true });
            nextRoundAnim.from($('#nextRound'), 2.5, { scale: 0, opacity:0, ease:Elastic.easeOut }, { scale: 1, opacity: 1, display: 'block'});
            nextRoundAnim.play();
            break;

        case 'game:last':

            break;

        case 'coins:add':
        case 'coins:remove':

            $('#' + eventData.type + '-coins span').text(eventData.amt);

            break;

        default:

            console.warn('No handler found for event "' + eventId + '" in socketEvents.');

            break;

    }

};