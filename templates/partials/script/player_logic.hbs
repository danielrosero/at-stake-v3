{{!< default}}
{{!-- 
/**
 * @Stake v3.0
 * Developed by Engagement Lab, 2016-2017
 * ==============
 * 
 * Script includes partial for PLAYERS global client logic
 * ==========
 */
--}}

var isEmulated = window.frameElement && window.frameElement.getAttribute('data-emulated');

$(document).ready(function() {

    function noSleeping() {
        // Prevent device sleep
        var noSleep = new NoSleep();
        noSleep.enable();

        document.removeEventListener('click', noSleeping);
    }
    // Enable no sleep on first click/tap
    document.addEventListener('click', noSleeping, false);

});

{{#ifnoteq environment "production"}}
{{#ifnoteq environment "development"}}
    {{!-- Smartlook integration --}}
   {{!--  window.smartlook||(function(d) {
        var o=smartlook=function(){ o.api.push(arguments)},h=d.getElementsByTagName('head')[0];
        var c=d.createElement('script');o.api=new Array();c.async=true;c.type='text/javascript';
        c.charset='utf-8';c.src='//rec.getsmartlook.com/recorder.js';h.appendChild(c);
        })(document);
        smartlook('init', 'f70bc72265f75e886b23785202aafc01c9b5c2e1');

    // Warn about reloading
    window.addEventListener("onbeforeunload", function (e) {

      (e || window.event).returnValue = null;
      return null;

    }); --}}
{{/ifnoteq}}
{{/ifnoteq}}

// Tap away any errors
$(document).on('click touchstart', 'div.error', function() {
    $(this).hide();
});



// Remove debugging for emulated (debug) player
if(isEmulated)
    $('#debugging').remove();

/*
    Logs the player in
*/
var playerLogin = function(data) {

    gameCode = data.code;

    $('.navbar').slideUp();
    
    // Open socket connection
    if(!socket) {
        socket = io('//{{host}}', {path: '/at-stake-socket', 'reconnection': true,'reconnectionDelay': 500,'maxReconnectionAttempts':Infinity});
        registerEvents();
    }

    $('gameContent').addClass('lobby');

    playerName = $('#player-name').val();
    sessionStorage.setItem('username', playerName);
    // sessionStorage.setItem('gameCode', gameCode);

    // Log player in
    socket.emit('login:submit', emitData({username: playerName, uid: data.uid}));

}

/*
    Checks if this client is logged in as a player already
*/
var checkIfLoggedIn = function() {

    // Disallow private/incognito
    if(isPrivate) {

        $('.form').show();
        $('.form input').hide();
        $('#error-private-mode').trigger('show');

        return;
    }
    
    // Check if game code saved to session (player is already logged in)
    if(!sessionStorage.getItem('gameCode')) {
        var isAndroid = /Android/ig.test(navigator.userAgent);

        $('.form.login').show();

        // Login form animation
        if(!isEmulated)
            loginFromTo('start', 'name');
        else
            $('#player-name, #btn_submit_name').removeClass('hidden-el');

        // For Android only, move input boxes into view on phones
        if(isAndroid) {
            $('.form input')
            .focus(function() { 
                $('#logo_ec').addClass('mobile');
            })
            .blur(function() { 
                $('#logo_ec').removeClass('mobile');
            });
        }

        $('#player-name').keydown(function(evt) {
            
            if(evt.keyCode == 13)
                $('#btn_submit_name').click();

        });

        return;
    }

    $('#resuming').show();

    gameCode = sessionStorage.getItem('gameCode');
    playerName = sessionStorage.getItem('username');

    $('#name, .login.input').fadeOut(function() {

        $('#begin').addClass('wait');
        $('#join, .login.waiting').fadeIn();

    });
    
    // Open socket connection
    if(!socket) { 
        socket = io('//{{host}}', {path: '/at-stake-socket', 'reconnection': true,'reconnectionDelay': 500,'maxReconnectionAttempts':Infinity});
        registerEvents();
    } 

}

var phaseBarProgress = function() {

    // Update progress bar
    $('#stages-bar #progress').css('width', (currentPhaseIndex * 17 ) + '%');

    // Change phase icon status
    $('#stages-bar .icon:eq('+currentPhaseIndex+')').removeClass('disabled');
    $('#stages-bar .icon:not(:eq('+currentPhaseIndex+'))').addClass('disabled');

}

var nextPhase = function() {

    currentPhaseIndex++;Â 

    phaseBarProgress();

    // Local session update
    // sessionStorage.setItem('markup', $('#gameContent').html());    
    sessionStorage.setItem('phase', currentPhaseIndex);    

}

var nextPhaseScreen = function() {
    
    currentScreenIndex++;

    //TODO: Animate
    $.when($($('.screen')[0]).remove()).then(function() {

        var newScreen = $('.screen')[0];
        // $(newScreen).show();
        
        // Local session update
        sessionStorage.setItem('markup', $('#gameContent').html());   
        sessionStorage.setItem('screen', currentScreenIndex);

        $(newScreen).trigger('show');

        var timerPreview = $($('.screen')[0]).find('.timer.preview');
        var hasTimer = timerPreview.length === 1;
        if(hasTimer) {
            new ProgressBar.Circle(
              '.screen .timer.preview', 
              {
                    color: '#fff',
                    strokeWidth: 6,
                    trailColor: 'rbga(235, 235, 235, 0.5)',
                    trailWidth: 0.8,
                    fill: '#20b5e6',
                    text: {
                        value: $(timerPreview[0]).data('duration')
                    }
              }
            );
        }

    });

}

/*
 Save player name and advance to next screen
*/
$(document).on('click', '.btn.submit_name', function(evt) {

    var data = getFormData($(this));
    var errorBox = $('.form .error');

    // Hide errors during typing
    $('.form input').keyup(function() {
        $('.form input').removeClass('invalid');
    });

    if(!data.name || data.name.length === 0) {
        $('.form #player-name').addClass('invalid');
        errorBox.text('You need to enter a name!').fadeIn(); 

        return;
    }

    $('#username').text(data.name);

    // Show new game/join
    loginFromTo('name', 'choices');
    

});

/* 
 Logs player into game with room code and name
*/
$(document).on('click', '.btn.game_login', function(evt) {

    var data = getFormData($(this));
    var errorBox = $('.form .error');

    // Hide errors during typing
    $('.form input').keyup(function() {
        $('.form input').removeClass('invalid');
    });

    // Player entered code?
    if(!data.code || data.code.length === 0) {
        $('.form #access_code').addClass('invalid');
        errorBox.text('You need to enter a room code!').fadeIn(); 

        return;
    }
    // Player entered name?
    else if(!data.name || data.name.length === 0) {
        $('.form #player-name').addClass('invalid');
        errorBox.text('You need to enter a name!').fadeIn(); 

        return;
    }

    // Create uid for player
    if(!sessionStorage.getItem('uUID')) {
        playerUID = Math.floor(Math.pow(10, 10-1) + Math.random() * (Math.pow(10, 10) - Math.pow(10, 10-1) - 1));
        sessionStorage.setItem('uUID', playerUID);
    }
    else 
        playerUID = sessionStorage.getItem('uUID');

    // Disable button and show loading modal
    if(!data.disable) {
        $(evt.currentTarget).attr('disabled', 'disabled');
        $('#loading-modal').fadeIn(250);
    }
    
    $.post(
        "/login",
        data,
        function( data ) {

            $('.form input').removeClass('invalid');

            if(data.error_code) {

                switch(data.error_code) {

                    case 'game_not_found': 
                        $('.form #access_code').addClass('invalid');
                        
                        // Session does not exist, make sure to clear data from storage
                        sessionStorage.removeItem('gameCode');
                        sessionStorage.removeItem('playerSubmission');
                        break;

                    case 'no_username':
                    case 'username_taken':
                        $('.form #player-name').addClass('invalid');
                        break;

                    case 'game_active': 
                        $('.form #access_code').addClass('invalid');
                        break;

                }
                $('.btn.game_login').removeAttr('disabled');
                errorBox.text(data.msg).fadeIn();
                loadToggle(false, true);

                return;

            }

            $('.login.input').fadeOut(function() {
                $('#lobby').addClass('wait');
                $('.login.waiting').fadeIn();
            });

            data.uid = playerUID;
            playerLogin(data);                          

        }
    );

});

/* 
 Get info for player when they ask to start new game
*/
$('#btn_new_game').click(function() {

    if($.trim( $('#decks').html() ).length > 0) {
        
        loginNewGame();
        return;
    }

    $.get(
        "/api/generate",
        function( data ) {

            gameCode = data.code;

            $('#decks')
             .html(data.html)
             .promise()
             .done(function() {

                loginNewGame(function() {

                    // Tell mobile action has completed
                    $('body').trigger('mobileCallback');
                    
                    $('#decks').glide({
                        type: 'carousel',
                        autoplay: false,
                        autoheight: true, 
                        paddings: 0
                    });
                    
                });

             });

             var gameCodeMarkup = '';
            _.each(data.code.split(''), function(char, i) {
                gameCodeMarkup += '<span>' + char + '</span>';
            });
            $('.access-code').html(gameCodeMarkup);
            $('#gameContent').addClass('lobby');

        }
    );

});

// Check if this client is logged in on server
window.onload = checkIfLoggedIn();

// Load events for players
{{> script/player_events gameType=gameType}}

{{#ifeq debug true}}
    // Debugging view
    {{#ifeq section 'play'}}
        $('#access_code').val('TEST');
        $('#player-name').val('Player_' + Math.floor(Math.random() * (10 - 1 + 1)) + 1);
    {{/ifeq}}
{{/ifeq}}

{{!-- // /play URL
{{#ifeq section 'login'}}

  $('.body').addClass('game-bg');
  $('.body').addClass('player');

{{/ifeq}} --}}