{{!< default}}
{{!-- 
/**
 * @Stake v3
 * Developed by Engagement Lab, 2016
 * ==============
 * 
 * Script includes partial for MODERATOR socket.io events
 * ==========
 */
--}}		

var clockInterval;

var deciderEvents = function(eventId, eventData) {
    
    switch (eventId) {

        case 'players:update':

            var staticPlayers = $('.player-static');
            var currentPlayers = _.pluck(eventData, 'username');

            {{!-- // Allow to start?
            if(currentPlayers.length === 2)
            {
                var startAnim = new TimelineLite();
                startAnim.from($('#btn-start-game'), 1, {scale:0, autoAlpha: 0, ease:Elastic.easeOut})
            } --}}

            _.each(currentPlayers, function(name, index) {

                var nameFormatted = (name.length <= 15) ? name : name.substring(0, 15) + "...";

                $('#players').append('<div class="col-sm-3">' + nameFormatted + '</div>');


            });

            break;

        case 'game:tutorial':
            
            $('#overlay').html(eventData).fadeIn();
            
            // Show countdown
            var secondsLeft = 8;
            var circle = new ProgressBar.Circle('#countdown', {
                color: '#fff',
                duration: 8000,
                easing: 'easeInOut',
                strokeWidth: 6,
                trailColor: '#f4f4f4',
                trailWidth: 0.8,
                fill: '#00c5c2',
                text: {
                    value: '8',
                    className: 'text',
                }
            });

            $('#countdown').click(function() {
                $('#overlay').fadeOut();
            });

            var tutorialCountdown = setInterval(function() {
                secondsLeft--;

                $('#countdown .text').text(secondsLeft);

                // End countdown and show arrow to continue
                if(secondsLeft == 0) {
                    clearInterval(tutorialCountdown);

                    var icon = $('#continue .icon').detach();
                    $('#countdown .text').empty();
                    icon.appendTo($('#countdown .text'));
                    
                    var continueAnim = new TimelineMax({ paused:true });
                    continueAnim
                    .from(icon, 1.5, {scale: 0, autoAlpha: 0, ease: Bounce.easeOut })
                    .from(icon, 1, {x: '+20', repeat: -1, yoyo: true, ease: Expo.easeOut });
                    // .to($('#countdown'), 1, {scale: 2, ease: Bounce.easeOut })
                    // .from($('#countdown'), 1, {scale: 2, ease: Bounce.easeOut, delay: 1 });

                    continueAnim.play();
                }
            }, 1000);

            circle.animate(1);

            break;

        case 'game:start':

            $('#gameContent').html(eventData.html);

           {{!--  {{#ifeq gameType "wikigeeks"}}
                $('.header').fadeIn();
            {{/ifeq}} --}}

            break;
            
        case 'game:countdown':

            if(clockInterval)
                clearInterval(clockInterval);

            {{#ifeq gameType "htyi"}}

                    var secondsLeft = eventData.duration;
                    var timeFactor = 360 / secondsLeft;
                    var clockHand = $('#clock-hand');
                        
                    clockInterval = setInterval(function() {

                        function clockTick() {
                            clockHand.css({
                                transform:'rotateZ('+ -(timeFactor*secondsLeft) + 'deg)'
                            });
                            secondsLeft--;
                        }

                        clockTick();

                        if(secondsLeft === 0)
                            clearInterval(clockInterval);
                    }, 1000);

            {{/ifeq}}  

            break;

        {{#ifnoteq environment "production"}}
            case 'debug:pause':
                countdownPaused = !countdownPaused;

                break;
        {{/ifnoteq}}

        default:

            console.warn('No groupview handler found for event "' + eventId + '"');

            break;

    }
    
};

var deciderLogin = function() {

    var deciderName = $('#player-name').val();

    if(!deciderName) {
        $('.submission .error').text('Please enter your name!').fadeIn();
        return;
    }

    isDecider = true;

    // Open socket connection
    socket = io();
    registerEvents();
    
}